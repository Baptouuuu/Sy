/*! sy#0.9.1 - 2014-10-04 */
function namespace(a){var b=null,c=this;if("string"==typeof a)b=a.split(".");else{if(!(a instanceof Array&&a.length>0))return c;b=a}return c[b[0]]=c[b[0]]||{},a=b.shift(),namespace.call(c[a],b)}function objectSetter(a,b){var c="",d="",e=this,f=a.lastIndexOf(".");f>=0?(d=a.substr(f+1),c=a.substr(0,f),e=namespace.call(e,c)):d=a,e[d]=b}function objectGetter(a){var b=null,c=this;if("string"==typeof a){if(b=a.split("."),1===b.length)return c[a]}else{if(!(a instanceof Array&&a.length>1))return a instanceof Array&&1===a.length?c[a[0]]:void 0;b=a}return a=b.shift(),objectGetter.call(c[a],b)}function capitalize(a){return a.substr(0,1).toUpperCase()+a.substr(1)}function reflectedObjectGetter(a){var b=null,c=this;if("string"==typeof a){if(b=a.split("."),1===b.length)return getReflectedValue.call(c,a)}else{if(!(a instanceof Array&&a.length>1))return a instanceof Array&&1===a.length?getReflectedValue.call(c,a[0]):void 0;b=a}return a=b.shift(),reflectedObjectGetter.call(getReflectedValue.call(c,a),b)}function getReflectedValue(a){var b=new ReflectionObject(this);return b.hasMethod("get"+capitalize(a))?b.getMethod("get"+capitalize(a)).call():b.hasMethod("get")?b.getMethod("get").call(a):b.hasProperty(a)?b.getProperty(a).getValue():void 0}namespace("Sy.AppState"),Sy.AppState.Route=function(){this.name=null,this.path=null,this.parameters={},this.requirements={},this.regex=null},Sy.AppState.Route.prototype=Object.create(Object.prototype,{setName:{value:function(a){return this.name=a,this}},getName:{value:function(){return this.name}},setPath:{value:function(a){return this.path=a,this}},getPath:{value:function(){return this.path}},setParameters:{value:function(a){return Object.isFrozen(this.parameters)||(this.parameters=a),Object.freeze(this.parameters),this}},getParameters:{value:function(){return this.parameters}},hasParameter:{value:function(a){return this.parameters.hasOwnProperty(a)}},getParameter:{value:function(a){return this.parameters[a]}},setRequirements:{value:function(a){return Object.isFrozen(this.requirements)||(this.requirements=a),Object.freeze(this.requirements),this}},getRequirements:{value:function(){return this.requirements}},getRequirement:{value:function(a){return this.requirements[a]}},hasRequirement:{value:function(a){return this.requirements.hasOwnProperty(a)}},buildRegex:{value:function(){var a=this.path.match(new RegExp(/{\w+}/g));return this.regex="^"+this.path+"$",a instanceof Array&&a.forEach(function(a){var b=a.substring(1,a.length-1);this.regex=this.hasRequirement(b)?this.regex.replace(a,"("+this.getRequirement(b)+")"):this.regex.replace(a,"(.+)")}.bind(this)),this}},matches:{value:function(a){return new RegExp(this.regex).test(a)}},getVariables:{value:function(a){var b=this.path.match(new RegExp(/{\w+}/g)),c=a.match(new RegExp(this.regex)),d={};if(!b)return d;b=b.map(function(a){return a.substring(1,a.length-1)}),c=c.filter(function(b){return b!==a});for(var e=0,f=b.length;f>e;e++)d[b[e]]=c[e];return d}}}),namespace("Sy.AppState"),Sy.AppState.Router=function(){this.provider=null},Sy.AppState.Router.prototype=Object.create(Object.prototype,{setRouteProvider:{value:function(a){if(!(a instanceof Sy.AppState.RouteProvider))throw new TypeError("Invalid route provider");return this.provider=a,this}},generate:{value:function(a,b){if(!this.provider.hasRoute(a))throw new ReferenceError('Unknown route "'+a+'"');var c=this.provider.getRoute(a),d=c.getParameters(),e=c.getPath();b=b||{};for(var a in d)d.hasOwnProperty(a)&&!b.hasOwnProperty(a)&&(b[a]=d[a]);for(var a in b)if(b.hasOwnProperty(a)){if(c.hasRequirement(a)&&!new RegExp("^"+c.getRequirement(a)+"$").test(b[a]))throw new SyntaxError('Variable "'+a+'" doesn\'t fulfill its requirement for the route "'+c.getName()+'"');e=e.replace("{"+a+"}",b[a])}return e}}}),namespace("Sy.AppState"),Sy.AppState.RouteProvider=function(){this.routes=null},Sy.AppState.RouteProvider.prototype=Object.create(Object.prototype,{setRegistry:{value:function(a){if(!(a instanceof Sy.RegistryInterface))throw new TypeError("Invalid registry");return this.routes=a,this}},setRoute:{value:function(a,b,c,d){var e=new Sy.AppState.Route;return e.setName(a).setPath(b),"object"==typeof c&&e.setParameters(c),"object"==typeof d&&e.setRequirements(d),e.buildRegex(),this.routes.set(a,e),this}},getRoute:{value:function(a){return this.routes.get(a)}},getRoutes:{value:function(){return this.routes.get()}},hasRoute:{value:function(a){return this.routes.has(a)}}}),namespace("Sy.AppState"),Sy.AppState.Core=function(){this.matcher=null,this.provider=null,this.generator=null,this.mediator=null,this.handler=null,this.currentState=null},Sy.AppState.Core.prototype=Object.create(Object.prototype,{setUrlMatcher:{value:function(a){if(!(a instanceof Sy.AppState.UrlMatcher))throw new TypeError("Invalid url matcher");return this.matcher=a,this}},setRouteProvider:{value:function(a){if(!(a instanceof Sy.AppState.RouteProvider))throw new TypeError("Invalid route provider");return this.provider=a,this}},setGenerator:{value:function(a){if(!(a instanceof Sy.Lib.Generator.Interface))throw new TypeError("Invalid generator");return this.generator=a,this}},setMediator:{value:function(a){if(!(a instanceof Sy.Lib.Mediator))throw new TypeError("Invalid mediator");return this.mediator=a,this}},setStateHandler:{value:function(a){if(!(a instanceof Sy.AppState.StateHandler))throw new TypeError("Invalid state handler");return this.handler=a,this}},boot:{value:function(){return history.state?(this.currentState=this.handler.getState(history.state.uuid),this.currentState||this.createState()):this.createState(),this.dispatchEvent(),window.addEventListener("popstate",this.listenPop.bind(this),!1),this}},listenPop:{value:function(a){a.state?(this.currentState=this.handler.getState(a.state.uuid),this.currentState||this.createState()):this.createState(),this.dispatchEvent()}},dispatchEvent:{value:function(){var a=new Sy.AppState.AppStateEvent;a.setState(this.currentState).setRoute(this.provider.getRoute(this.currentState.getRoute())),this.mediator.publish(a.KEY,a)}},createState:{value:function(){var a=this.getUrl(),b=this.matcher.match(a);this.currentState=this.handler.createState(this.generator.generate(),b.getName(),b.getVariables(a)),this.updateBrowserState()}},updateBrowserState:{value:function(){history.replaceState(this.currentState.toJSON(),document.title)}},getUrl:{value:function(){return location.hash.substr(1)||"/"}},getCurrentState:{value:function(){return this.currentState}}}),namespace("Sy.AppState"),Sy.AppState.UrlMatcher=function(){this.provider=null},Sy.AppState.UrlMatcher.prototype=Object.create(Object.prototype,{setRouteProvider:{value:function(a){if(!(a instanceof Sy.AppState.RouteProvider))throw new TypeError("Invalid route provider");return this.provider=a,this}},match:{value:function(a){for(var b,c=this.provider.getRoutes(),d=0,e=c.length;e>d;d++)if(c[d].matches(a)){b=c[d];break}if(!b)throw new ReferenceError('No route found for the url "'+a+'"');return b}}}),namespace("Sy.AppState"),Sy.AppState.State=function(){this.uuid=null,this.route=null,this.variables={}},Sy.AppState.State.prototype=Object.create(Object.prototype,{setUUID:{value:function(a){return this.uuid=a,this}},getUUID:{value:function(){return this.uuid}},setRoute:{value:function(a){return this.route=a,this}},getRoute:{value:function(){return this.route}},setVariables:{value:function(a){return this.variables=a,this}},getVariables:{value:function(){return this.variables}},toJSON:{value:function(){return{uuid:this.uuid,route:this.route,variables:this.variables}}}}),namespace("Sy.AppState"),Sy.AppState.StateHandler=function(){this.storage=localStorage,this.key="sy::history",this.states=[],this.loadStates(),window.addEventListener("beforeunload",this.saveHistory.bind(this),!1)},Sy.AppState.StateHandler.prototype=Object.create(Object.prototype,{loadStates:{value:function(){var a=this.storage.getItem(this.key);a&&(a=JSON.parse(a),a.forEach(function(a){this.states.push(this.createState(a.uuid,a.route,a.variables))}.bind(this)))}},createState:{value:function(a,b,c){var d=new Sy.AppState.State;return 10===this.states.length&&this.states.shift(),this.states.push(d),d.setUUID(a).setRoute(b).setVariables(c)}},getState:{value:function(a){for(var b=0,c=this.states.length;c>b;b++)if(this.states[b].getUUID()===a)return this.states[b]}},saveHistory:{value:function(){this.storage.setItem(this.key,JSON.stringify(this.states))}}}),namespace("Sy.AppState"),Sy.AppState.AppStateEvent=function(){this.state=null,this.route=null},Sy.AppState.AppStateEvent.prototype=Object.create(Object.prototype,{KEY:{value:"appstate.change",writable:!1},setState:{value:function(a){if(!(a instanceof Sy.AppState.State))throw new TypeError("Invalid state object");return this.state=a,this}},getState:{value:function(){return this.state}},setRoute:{value:function(a){if(!(a instanceof Sy.AppState.Route))throw new TypeError("Invalid route");return this.route=a,this}},getRoute:{value:function(){return this.route}}});